//go:generate go-bindata -pkg ui -o internal/ui/ui.go -prefix "internal/ui/" -nometadata internal/ui/templates/
//go:generate go-bindata -pkg static -o internal/static/static.go -nomemcopy -fs -prefix "internal/static/files/" internal/static/files/...

package main

import (
	"fmt"
	"log"
	"net/http"
	"os"
	"time"

	"github.com/gorilla/mux"
	"github.com/shreddedbacon/twcmanager/internal/controller"
	"github.com/shreddedbacon/twcmanager/internal/static"
	"github.com/tarm/serial"
	"gopkg.in/robfig/cron.v2"
	"gopkg.in/yaml.v2"
)

func main() {

	configPath := "./config.yml"
	file, err := os.Open(configPath)
	if err != nil {
		log.Fatal(err)
	}
	defer file.Close()
	d := yaml.NewDecoder(file)

	twcConfig := &controller.TWCPrimary{}
	// Start YAML decoding from file
	if err := d.Decode(&twcConfig); err != nil {
		log.Fatal(err)
	}
	// Set the ID of the primary controller
	twcConfig.ID = []byte{0x77, 0x77}

	// Create the serial port configuration
	serialConfig := &serial.Config{
		Name:        twcConfig.SerialConfig.DevicePath,
		Baud:        twcConfig.SerialConfig.BaudRate,
		ReadTimeout: 750 * time.Millisecond,
		Size:        8,
	}
	twcConfig.ConfigPath = configPath
	sPort, err := newSerialPort(serialConfig)
	if err != nil {
		log.Fatal(err)
	}

	// Create the primary TWC controller
	p, err := controller.NewPrimary(
		*twcConfig,
		sPort.port,
	)
	if err != nil {
		log.Fatal(err)
	}
	// pre start the controller
	p.PreStart()
	// then actually run it
	go p.Run()
	// start the LED loop
	go p.LEDLoop()

	c := cron.New()
	// Add the cron runner, every second
	c.AddFunc("* * * * * *", func() {
		p.RunCron()
	})
	// start crons.
	c.Start()

	// start the webservice
	r := mux.NewRouter()
	r.PathPrefix("/static/").Handler(http.StripPrefix("/static/", http.FileServer(static.AssetFile())))
	r.HandleFunc("/favicon.ico", faviconHandler)
	// API
	// Handle setting the maximum available amperate
	r.HandleFunc("/api/v1/maxamps/{availableAmps}", p.APISetMaxAmpsHandler).Methods("GET")
	r.HandleFunc("/api/v1/maxamps", p.APISetMaxAmpsHandler).Methods("POST")

	// Handle setting the maximum available amperage using available watts
	r.HandleFunc("/api/v1/maxwatts/{availableWatts}", p.APISetMaxWattsHandler).Methods("GET")
	r.HandleFunc("/api/v1/maxwatts", p.APISetMaxWattsHandler).Methods("POST")

	// Handle actions against specific TWCs
	// r.HandleFunc("/api/v1/disable/all", p.APIDisableTWC).Methods("POST")
	r.HandleFunc("/api/v1/disable", p.APIStopCharging).Methods("POST")
	r.HandleFunc("/api/v1/disable/{twcid}", p.APIStopCharging).Methods("GET")
	// r.HandleFunc("/api/v1/enable/all", p.APIEnableTWC).Methods("POST")
	r.HandleFunc("/api/v1/enable", p.APIStartCharging).Methods("POST")
	r.HandleFunc("/api/v1/enable/{twcid}", p.APIStartCharging).Methods("GET")

	// Tesla API functions
	r.HandleFunc("/api/v1/teslapi/auth", p.TeslaAPIAuth).Methods("POST")

	// Handle general API functions
	r.HandleFunc("/api/v1/debug/{debugLevel}", p.APISetDebugLevel).Methods("POST")
	r.HandleFunc("/api/v1/stats", p.APIGetStats).Methods("GET")
	r.HandleFunc("/api/v1/settings", p.APISettings).Methods("GET", "POST")
	r.HandleFunc("/api/v1/powerwallsettings", p.APIPowerwallSettings).Methods("GET", "POST")
	r.HandleFunc("/api/vi/send/{msg}", p.CustomMessage)

	r.HandleFunc("/api/v1/pollvin", p.APIPollVIN).Methods("POST")
	r.HandleFunc("/api/v1/pollplugstate", p.APIPollPlugState).Methods("POST")
	r.HandleFunc("/api/v1/pollfirmware", p.APIPollFirmwareInfo).Methods("POST")

	// Template serving pages
	r.HandleFunc("/", p.GetWallConnectors)
	r.HandleFunc("/info/{twcid}", p.GetWallConnectorInfo)
	r.HandleFunc("/settings", p.GetPrimarySettings)
	r.HandleFunc("/powerwall", p.GetPowerwallSettings)
	r.HandleFunc("/accounts", p.GetTeslaAPIUsers)

	r.HandleFunc("/vehicleslist", p.ListTeslaAPIVehicles)
	r.HandleFunc("/powerwall/stats", p.GetPowerwallSiteUsage)

	http.Handle("/", r)
	err = http.ListenAndServe(":8080", nil)
	if err != nil {
		fmt.Println(err)
	}

}

func faviconHandler(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "image/x-icon")
	w.Header().Set("Cache-Control", "public, max-age=7776000")
	fmt.Fprintf(w, "data:image/x-icon;base64,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zAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMBAAAzPAAAMz8AADMEAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwiAADM/wAAzP8AAMw6AADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzE4AAMz/AADM/wAAzGgAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMfAAAzP8AAMz/AADMlAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMyqAADM/wAAzP8AAMzCAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzNYAAMz/AADM/wAAzOwAAMwCAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwMAADM+gAAzP8AAMz/AADM/wAAzB4AAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzDQAAMz/AADM/wAAzP8AAMz/AADMSgAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMYgAAzP8AAMz/AADM/wAAzP8AAMx4AADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMyOAADM/wAAzP8AAMz/AADM/wAAzKQAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzLwAAMz/AADM/wAAzP8AAMz/AADM0gAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwCAADM6AAAzP8AAMz/AADM/wAAzP8AAMz4AADMBgAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzBgAAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMwuAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMRgAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzFoAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMxyAADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADMiAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzKAAAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMy0AADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzACdnesAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMzgAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzOAAAMwCAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwAAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAgAAMwAAADMAAAAzAAAAMwAAADMAAAAzAYAAMz2AADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzBIAAMwAAADMAAAAzAAAAMwAAADMAAAAzAgAAMwAAADMAAAAzAAAAMwAnZ3rAAAAzAAAAMwAAADMAAAAzA4AAMyMAADM1AAAzAQAAMwAAADMAAAAzAAAAMwAAADMKgAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADMPgAAzAAAAMwAAADMAAAAzAAAAMwCAADMwAAAzJoAAMwWAADMAAAAzACdnesAAADMAAAAzAAAAMwwAADM3gAAzP8AAMz/AADMmAAAzBoAAMwCAADMAAAAzAAAAMxYAADM/wAAzP8AAMz/AADM/wAAzPoAAMz/AADM/wAAzP8AAMxqAADMAAAAzAAAAMwCAADMFgAAzIYAAMz/AADM/wAAzOgAAMxAAADMAJ2d6wAAAMwAAADMLAAAzO4AAMz/AADM/wAAzP8AAMz/AADM/wAAzOIAAMzKAADMwAAAzNoAAMz/AADM/wAAzP8AAMyCAADMaAAAzP8AAMz/AADM/wAAzOAAAMzAAADMygAAzOAAAMz8AADM/wAAzP8AAMz/AADM/wAAzPYAAMw+nZ3rAAAAzAIAAMwoAADMnAAAzPIAAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADMrgAAzAIAAMwCAADMlgAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzP8AAMz2AADMpgAAzDKdnesCAADMXgAAzMIAAMxcAADMGAAAzFgAAMymAADM6AAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzNIAAMwOAADMAAAAzAAAAMwGAADMwAAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzO4AAMyuAADMYAAAzBoAAMxSAADMtm9v4ngAAMzSAADM/wAAzP8AAMzyAADMqgAAzF4AAMwcAADMKgAAzF4AAMyKAADMrgAAzMoAAMzSAADMIgAAzAAAAMwAAADMAAAAzAAAAMwWAADMygAAzMwAAMyyAADMjgAAzGIAAMwuAADMGAAAzFYAAMygAADM7gAAzP8AAMz/CQnN6AAAzBYAAMxuAADMxAAAzPwAAMz/AADM/wAAzP8AAMzaAADMpgAAzHgAAMxQAADMMgAAzBgAAMwKAADMBAAAzAIAAMwAAADMBAAAzAoAAMwWAADMLgAAzE4AAMx0AADMoAAAzNQAAMz/AADM/wAAzP8AAMz/AADMzAAAzHaPj+gcAADMAAAAzAAAAMwCAADMGgAAzGIAAMymAADM5AAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzPwAAMz2AADM9AAAzPQAAMz2AADM+gAAzP8AAMz/AADM/wAAzP8AAMz/AADM/wAAzOgAAMysAADMagAAzCAAAMwCAADMAJ2d6wAAAMwAAADMAAAAzAAAAMwAAADMAAAAzAAAAMwCAADMHgAAzE4AAMx6AADMngAAzL4AAMzWAADM6gAAzPYAAMz/AADM/wAAzPgAAMzqAADM2AAAzMAAAMyiAADMfgAAzFIAAMwiAADMAgAAzAAAAMwAAADMAAAAzAAAAMwAnZ3rAP////////////9////+f////n////5////+f////n////4////8P////D////w////8P////D////gf///4H///+B////gf///4H///+A////AP///wD///8A//8/APz+HwD4fAAIADwAGAA7gDwB0Hh+HgwH/+A/gAAB//wAP/\n")
}

// SerialPort .
type SerialPort struct {
	port *serial.Port
}

func newSerialPort(config *serial.Config) (*SerialPort, error) {
	port, err := serial.OpenPort(config)
	if err != nil {
		log.Fatal(err)
	}
	return &SerialPort{
		port: port,
	}, nil
}
